import pandas as pd
import argparse
from scipy.spatial import distance
import time

TargetSet = {}
t = float('inf')
k = 0
query_latitude = 0
query_longitude = 0

def query_to_point_in_cell(abscissa, ordinate, dataframe):
	# q might not be in the grid
	has_pruned_entire_layer = True
	for index, row in dataframe.loc[(dataframe['ordinate'] == ordinate) & (dataframe['abscissa'] == abscissa)].iterrows():
		distance = ((row['latitude'] - query_latitude)**2 + (row['longitude'] - query_longitude)**2)**0.5
		if len(TargetSet) < k:
			TargetSet[index] = distance
			t = max(TargetSet, key=TargetSet.get)
		else:		
			if distance < t:
				del_key = TargetSet.keys()[TargetSet.values().index(t)] # only one
				TargetSet.pop(del_key, None)
				TargetSet[index] = distance
				t = max(TargetSet, key=TargetSet.get)
				has_pruned_entire_layer = False

	return has_pruned_entire_layer

def query_to_cell(abscissa, ordinate):
	xlow = min_latitude + abs(abscissa) * latitude_interval
	xhigh = min_latitude + (abs(abscissa) + 1) * latitude_interval
	ylow = min_longitude + abs(ordinate) * longitude_interval
	yhigh = min_longitude + (abs(ordinate) + 1) * longitude_interval

	return min(distance.euclidean((query_latitude, query_longitude), (xlow, ylow)), distance.euclidean((query_latitude, query_longitude), (xlow, yhigh)), distance.euclidean((query_latitude, query_longitude), (xhigh, ylow)), distance.euclidean((query_latitude, query_longitude), (xhigh, yhigh)))


if __name__ == "__main__":

	parser = argparse.ArgumentParser(description = "Nearest neighbor search technique on grid-indexed data")

	parser.add_argument('-x', type=float, help = "latitude of query location q", required=True)
	parser.add_argument('-y', type=float, help = "longitude of query location q", required=True)
	parser.add_argument('-k', type=int, help = "integer k", required=True)

	args = parser.parse_args()
	k = args.k
	query_latitude = args.x
	query_longitude = args.y

	df = pd.read_csv('Gowalla_totalCheckins.txt', sep="\t", header=None)

	df.columns = ["user", "check-in time", "latitude", "longitude", "location id"]

	max_latitude =  df['latitude'].max()
	max_longitude = df['longitude'].max()
	min_latitude =  df['latitude'].min()
	min_longitude = df['longitude'].min()

	latitude_interval = (max_latitude - min_latitude) / 100.0
	longitude_interval = (max_longitude - min_longitude) / 100.0

	df["abscissa"] = (df['latitude'] - min_latitude) // latitude_interval
	df["ordinate"] = (df['longitude'] - min_longitude) // longitude_interval

	#df.to_csv('Gowalla_totalCheckins_modified.txt', sep='\t')
	
	query_abscissa = (args.x - min_latitude) // latitude_interval
	query_ordinate = (args.y - min_longitude) // longitude_interval

	print(query_abscissa)

	start = time.time()

	query_to_point_in_cell(query_abscissa, query_ordinate, df)

	has_pruned_entire_layer = True

	i = 1

	while True:
		# layer
		for x in xrange(int(query_ordinate - i), int(query_ordinate + i)):
			if query_abscissa - i >= min_latitude && x <= max_longitude && x >= min_longitude:
				if query_to_cell(query_abscissa - i, x) <= t:
					has_pruned_entire_layer = query_to_point_in_cell(query_abscissa - i, x, df)

		for x in xrange(int(query_ordinate - i), int(query_ordinate + i)):
			if query_abscissa + i <= max_latitude && x <= max_longitude && x >= min_longitude:
				if query_to_cell(query_abscissa + i, x) <= t:
					has_pruned_entire_layer = query_to_point_in_cell(query_abscissa + i, x, df)

		for x in xrange(int(query_abscissa - i), int(query_abscissa + i)):
			if query_ordinate + i <= max_longitude && x <= max_latitude && x >= min_latitude:
				if query_to_cell(x, query_ordinate + i) <= t:
					has_pruned_entire_layer = query_to_point_in_cell(x, query_ordinate + i, df)
		
		for x in xrange(int(query_abscissa - i), int(query_abscissa + i)):
			if query_ordinate - i >= min_longitude && x <= max_latitude && x >= min_latitude:
				if query_to_cell(x, query_ordinate - i) <= t:
					has_pruned_entire_layer = query_to_point_in_cell(x, query_ordinate - i, df)

		if has_pruned_entire_layer == True:
			break

		i += 1

	end = time.time()
	elapsed = end - start
	print("Elapsed time = ", elapsed)
	print("TargetSet = ", TargetSet)
